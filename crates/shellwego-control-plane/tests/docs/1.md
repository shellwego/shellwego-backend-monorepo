This is the "Brain" of the operation. If this fails, the whole cloud goes dark. We aren't testing JSON serialization; we're testing **state consistency, scheduling bin-packing, and mesh reliability.**

To run this without mocks, you need a real DB and the QUIC mesh active.

### ðŸ›  VPS Setup (Control Plane Infra)
```bash
# 1. Install Postgres (Real DB, no SQLite toy for 'production proof')
sudo apt install -y postgresql postgresql-contrib
sudo -u postgres psql -c "CREATE USER swg WITH PASSWORD 'swg';"
sudo -u postgres psql -c "CREATE DATABASE shellwego OWNER swg;"

# 2. SQLx CLI for migrations
cargo install sqlx-cli --no-default-features --features postgres
export DATABASE_URL=postgres://swg:swg@localhost/shellwego
sqlx migrate run --source crates/shellwego-control-plane/migrations
```

---

### 1. Unit Tests (Logic & Auth)
*Target: `src/services/scheduler.rs`, `src/api/handlers/auth.rs`*
*Goal: Fast, stateless math and crypto.*

*   **TC-CP-U1: Bin-Packing Scheduler Accuracy**
    *   Input: 3 Nodes (10% used, 50% used, 90% used). Request for a high-RAM app.
    *   Verify: Scheduler picks the 10% node. No questions asked.
*   **TC-CP-U2: JWT Scoping & RBAC**
    *   Action: Generate token with `apps:read` scope. Try to access `nodes:write`.
    *   Verify: Validator returns `403 Forbidden` immediately.
*   **TC-CP-U3: Resource Validator**
    *   Input: `cpu_milli: 0`, `memory_bytes: 1024`.
    *   Verify: Validator catches the impossible resource request before it hits the DB.

---

### 2. Integration Tests (Persistence & Mesh)
*Target: `src/orm/`, `src/quinn/server.rs`, `src/events/bus.rs`*
*Goal: Prove the data actually lives and moves.*

*   **TC-CP-I1: Sea-ORM Entity Mapping**
    *   Action: CRUD an `App` with complex many-to-many `Volumes` and `Domains`.
    *   Verify: Postgres confirms row insertion; relations are fetched correctly in one query.
*   **TC-CP-I2: QUIC Mesh Handshake**
    *   Action: Spin up `QuinnServer`. Start a real `QuinnClient` (from agent crate).
    *   Verify: Control Plane `agents` DashMap shows the node as `Registered` via actual TLS certificates.
*   **TC-CP-I3: Event Bus Fan-out**
    *   Action: Publish `app.crashed`. Subscribe three different workers (Audit, Webhook, Notification).
    *   Verify: All three workers receive the exact payload within <5ms.
*   **TC-CP-I4: Distributed Rate Limiting**
    *   Action: Hammer the `API Key` token bucket in a tight loop.
    *   Verify: 101st request returns `429 Too Many Requests`.

---

### 3. E2E Tests (The Sovereign Workflow)
*Target: `src/main.rs`*
*Goal: The full Hacker News demo loop.*

*   **TC-CP-E2E-1: The "New Customer" Onboarding**
    1.  **Auth:** `POST /v1/auth/register` -> Store user.
    2.  **Org:** `POST /v1/organizations` -> Setup billing and base slug.
    3.  **App:** `POST /v1/apps` -> "sovereign-blog" image.
    4.  **Verify:** DB state is `Creating`, NATS/QUIC message `ScheduleApp` is dispatched to the mesh.
*   **TC-CP-E2E-2: Multi-Region Failover Simulation**
    1.  Mark Node A as `Offline` in DB.
    2.  Trigger `Scheduler::evacuate(node_a_id)`.
    3.  Verify: All apps on Node A are rescheduled to Node B.
    4.  Verify: `Deployment` records show the migration event.
*   **TC-CP-E2E-3: Managed Database Provisioning**
    1.  Request Postgres DB via API.
    2.  Verify: `DatabaseOperator` generates encrypted credentials, stores them in `Secrets`, and returns the connection string (minus password).

---

### ðŸš€ How to Run
We use `tokio::test` with a real DB connection. No `MockDatabase`.

```makefile
test-cp-real:
	# Sets up a clean DB per test run
	DATABASE_URL=$(DATABASE_URL) cargo test -p shellwego-control-plane -- --test-threads=1
```

**Production Proof:** If these integration tests pass, your Control Plane isn't just a CRUD app; it's a distributed state machine capable of managing thousands of microVMs across a mesh. **AWS who?**